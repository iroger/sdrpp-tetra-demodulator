name: Build Module macOS
on: push

env:
  BUILD_TYPE: Release
  LIB_NAME: tetra_demodulator.dylib

jobs:
  build_macos:
    runs-on: macos-latest
    steps:
      - name: Repo checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install fftw glfw volk zstd talloc cmake pkg-config
          echo "CPATH=$(brew --prefix)/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$(brew --prefix)/lib" >> $GITHUB_ENV

      - name: Get SDR++ source
        run: |
          wget https://github.com/AlexandreRouma/SDRPlusPlus/archive/refs/heads/master.tar.gz
          mkdir -p sdrpp_source
          tar -zxvf master.tar.gz -C sdrpp_source --strip-components=1

      - name: Get SDR++ Core (macOS)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: 'AlexandreRouma/SDRPlusPlus'
          version: 'tags/nightly'
          file: 'sdrpp_macos_arm.zip' 
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unpack SDR++ Core
        run: |
          mkdir -p sdrpp_runtime
          unzip sdrpp_macos_arm.zip -d sdrpp_runtime
          CORE_LIB_FULLPATH=$(find "$GITHUB_WORKSPACE/sdrpp_runtime" -name "*sdrpp_core.dylib" | head -n 1)
          CORE_LIB_DIR=$(dirname "$CORE_LIB_FULLPATH")
          echo "CORE_LIB_DIR=$CORE_LIB_DIR" >> $GITHUB_ENV
          echo "CORE_LIB_NAME=$(basename $CORE_LIB_FULLPATH)" >> $GITHUB_ENV
          cp ./.github/workflows/sdrpp_module_hack.cmake ./

      - name: Patch Hack Code for macOS
        run: |
          CORE_LIB_FULLPATH=$(find "$GITHUB_WORKSPACE/sdrpp_runtime" -name "*sdrpp_core.dylib" | head -n 1)
          
          # Update hack file for core library path and include logic
          sed -i '' "s|\"\${SDRPP_LIB_ROOT}/libsdrpp_core.so\"|\"$CORE_LIB_FULLPATH\"|g" sdrpp_module_hack.cmake
          sed -i '' 's|${SDRPP_CORE_ROOT}/src/|${SDRPP_CORE_ROOT}/core/src/|g' sdrpp_module_hack.cmake

          # Inject Volk and FFTW linking
          echo 'if (APPLE)' >> sdrpp_module_hack.cmake
          echo '    target_link_libraries(${PROJECT_NAME} PRIVATE volk fftw3f)' >> sdrpp_module_hack.cmake
          echo 'endif ()' >> sdrpp_module_hack.cmake
          
      - name: Download ETSI codec
        run: |
          cd src/decoder/etsi_codec-patches
          chmod +x download_and_patch.sh
          ./download_and_patch.sh

      - name: CMake Configuration
        run: |
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="$(brew --prefix)" \
            -DSDRPP_CORE_ROOT="$GITHUB_WORKSPACE/sdrpp_source" \
            -DSDRPP_LIB_ROOT="${{ env.CORE_LIB_DIR }}" \
            -DSDRPP_MODULE_CMAKE="$GITHUB_WORKSPACE/sdrpp_module_hack.cmake"

      - name: Build
        run: |
          cd build
          # Strip C++17 from C files to prevent conflicts
          find . -name "flags.make" -exec sed -i '' '/C_FLAGS =/s/-std=c++17//g' {} +
          
          export LIBRARY_PATH="${{ env.CORE_LIB_DIR }}:$(brew --prefix)/lib"
          make -j$(sysctl -n hw.ncpu)

      - name: Make Library Portable (Fix Load Errors)
        run: |
          cd build
          if [ -f "${{ env.LIB_NAME }}" ]; then
            echo "Fixing library load paths..."
            
            # 1. Convert absolute Volk/FFTW paths to @rpath
            # This handles the exact error you saw
            VOLK_PATH=$(otool -L ${{ env.LIB_NAME }} | grep libvolk | awk '{print $1}')
            FFTW_PATH=$(otool -L ${{ env.LIB_NAME }} | grep libfftw3f | awk '{print $1}')
            
            install_name_tool -change "$VOLK_PATH" "@rpath/$(basename $VOLK_PATH)" ${{ env.LIB_NAME }}
            install_name_tool -change "$FFTW_PATH" "@rpath/$(basename $FFTW_PATH)" ${{ env.LIB_NAME }}
            
            # 2. Add search paths so it finds Homebrew or App-bundled libs
            install_name_tool -add_rpath "/opt/homebrew/lib" ${{ env.LIB_NAME }}
            install_name_tool -add_rpath "/usr/local/lib" ${{ env.LIB_NAME }}
            install_name_tool -add_rpath "@executable_path/../Frameworks" ${{ env.LIB_NAME }}
            
            # 3. Fix SDR++ Core reference to be relative to the App bundle
            CORE_REF=$(otool -L ${{ env.LIB_NAME }} | grep sdrpp_core | awk '{print $1}')
            install_name_tool -change "$CORE_REF" "@executable_path/../Frameworks/${{ env.CORE_LIB_NAME }}" ${{ env.LIB_NAME }}

            # 4. Resign the binary after modifications
            codesign -f -s - ${{ env.LIB_NAME }}
            
            echo "Updated Library Load Map:"
            otool -L ${{ env.LIB_NAME }}
          else
            echo "Build file not found, skipping fix."
            exit 1
          fi

      - name: Upload library
        uses: actions/upload-artifact@v4
        with:
          name: tetra_demodulator_macos
          path: ./build/${{ env.LIB_NAME }}
