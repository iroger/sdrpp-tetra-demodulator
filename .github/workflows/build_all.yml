name: Build Module macOS
on: push

env:
  BUILD_TYPE: Release
  LIB_NAME: tetra_demodulator.dylib

jobs:
  build_macos:
    runs-on: macos-latest
    steps:
      - name: Repo checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install fftw glfw volk zstd talloc cmake pkg-config

      - name: Get SDR++ source
        run: |
          wget https://github.com/AlexandreRouma/SDRPlusPlus/archive/refs/heads/master.tar.gz
          mkdir -p sdrpp_lib
          tar -zxvf master.tar.gz -C sdrpp_lib --strip-components=1

      - name: Get SDR++ Core (macOS)
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: 'AlexandreRouma/SDRPlusPlus'
          version: 'tags/nightly'
          file: 'sdrpp_macos_arm.zip' 
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Unpack SDR++ Core
        run: |
          mkdir -p sdrpp_runtime
          unzip sdrpp_macos_arm.zip -d sdrpp_runtime
          REAL_APP_PATH=$(find sdrpp_runtime -name "SDR++.app" -type d | head -n 1)
          echo "APP_PATH=$REAL_APP_PATH" >> $GITHUB_ENV
          cp ./.github/workflows/sdrpp_module_hack.cmake ./

      - name: Download ETSI codec
        run: |
          cd src/decoder/etsi_codec-patches
          chmod +x download_and_patch.sh
          ./download_and_patch.sh

      - name: CMake Configuration
        run: |
          mkdir build
          cd build
          
          # Injecting Homebrew paths into the environment for the linker and compiler
          export CPATH="$(brew --prefix)/include"
          export LIBRARY_PATH="$(brew --prefix)/lib"
          
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="$(brew --prefix);$(brew --prefix talloc)" \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DSDRPP_CORE_ROOT="$GITHUB_WORKSPACE/sdrpp_lib/core" \
            -DSDRPP_LIB_ROOT="${{ env.APP_PATH }}/Contents/Frameworks" \
            -DSDRPP_MODULE_CMAKE="$GITHUB_WORKSPACE/sdrpp_module_hack.cmake"

      - name: Build
        run: |
          cd build
          # Re-apply the C-file fix for Clang
          find . -name "flags.make" -exec sed -i '' 's/-std=c++17//g' {} +
          
          # Set library path for the linker
          export LIBRARY_PATH="$(brew --prefix)/lib"
          
          make -j$(sysctl -n hw.ncpu)
          
          if [ -f "${{ env.LIB_NAME }}" ]; then
            otool -L ${{ env.LIB_NAME }}
          else
            echo "Build failed: ${{ env.LIB_NAME }} not found."
            # Check for actual linker errors if the file is missing
            exit 1
          fi

      - name: Upload library
        uses: actions/upload-artifact@v4
        with:
          name: tetra_demodulator_macos
          path: ./build/${{ env.LIB_NAME }}
          
